apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gxa-data-rwo
  namespace: jenkins-gene-expression
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gxa-data-populator
  namespace: jenkins-gene-expression
spec:
  template:
    spec:
      volumes:
        - name: gxa-data-vol
          persistentVolumeClaim:
            claimName: gxa-data-rwo
      containers:
      - name: gxa-data-ftp
        image: takkatakka/lftp
        env:
        - name: EXP_IDS
          value: "E-CURD-4 E-EHCA-2 E-GEOD-71585 E-GEOD-81547 E-GEOD-99058 E-MTAB-5061 E-ENAD-53"
        command: ["sh", "-c"]
        args:
          - lftp -e "get /pub/databases/arrayexpress/data/atlas/atlas-ci/species-properties.json -o /gxa-data; exit" ftp.ebi.ac.uk;
            lftp -e "get /pub/databases/arrayexpress/data/atlas/atlas-ci/release-metadata.json -o /gxa-data; exit" ftp.ebi.ac.uk;
            lftp -e "get /pub/databases/arrayexpress/data/atlas/sc_experiments/cell_stats.json -o /gxa-data/magetab; exit" ftp.ebi.ac.uk;
            for EXP_ID in ${EXP_IDS}; do lftp -e "mirror -vvv /pub/databases/arrayexpress/data/atlas/sc_experiments/${EXP_ID} /gxa-data/magetab/${EXP_ID}; exit" ftp.ebi.ac.uk; done;
        volumeMounts:
          - mountPath: "/gxa-data"
            name: gxa-data-vol
      restartPolicy: Never
  backoffLimit: 4

